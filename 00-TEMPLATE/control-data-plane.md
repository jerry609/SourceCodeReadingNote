# 控制面与数据面分离 (Control vs Data Plane)

> 大脑只做决策，四肢只做动作。
> 长期演进最怕"把环境差异写进核心"。

## 设计原则

- **控制面 (Control Plane)**: 定义事实、做决策、协调、保证一致性与策略入口
- **数据/执行面 (Data/Worker Plane)**: 贴近环境完成动作，允许多实现并行

---

## 架构概览

```
┌─────────────────────────────────────────────────────────────┐
│                      Control Plane                          │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐ │
│  │ API Server  │  │  Scheduler  │  │  Controller Manager │ │
│  │ (事实定义)   │  │  (决策)     │  │  (协调/收敛)        │ │
│  └─────────────┘  └─────────────┘  └─────────────────────┘ │
│                           │                                 │
│                    ┌──────┴──────┐                         │
│                    │    Storage   │                         │
│                    │  (状态持久化) │                         │
│                    └─────────────┘                         │
└─────────────────────────────────────────────────────────────┘
                            │
            ┌───────────────┼───────────────┐
            ▼               ▼               ▼
┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐
│   Data Plane    │ │   Data Plane    │ │   Data Plane    │
│   (实现 A)      │ │   (实现 B)      │ │   (实现 C)      │
│  ┌───────────┐  │ │  ┌───────────┐  │ │  ┌───────────┐  │
│  │  Worker   │  │ │  │  Worker   │  │ │  │  Worker   │  │
│  │  Agent    │  │ │  │  Agent    │  │ │  │  Agent    │  │
│  └───────────┘  │ │  └───────────┘  │ │  └───────────┘  │
└─────────────────┘ └─────────────────┘ └─────────────────┘
```

---

## 控制面组件

| 组件 | 职责 | 状态管理 | 决策类型 | 源码位置 |
|:-----|:-----|:---------|:---------|:---------|
| ... | ... | 有状态/无状态 | 调度/协调/策略 | `path/to/` |

### 组件 1: [名称]

**职责**: ...

**决策逻辑**:
```go
// 核心决策代码
```

**依赖**: 只依赖抽象接口，不依赖具体实现

---

## 数据面组件

| 组件 | 职责 | 可替换性 | 环境依赖 | 源码位置 |
|:-----|:-----|:---------|:---------|:---------|
| ... | ... | 高/中/低 | 云厂商/OS/硬件 | `path/to/` |

### 组件 1: [名称]

**职责**: ...

**接口契约**:
```go
type DataPlaneInterface interface {
    // 控制面只通过这个接口与数据面交互
}
```

**多实现支持**:
- 实现 A: 适用于场景 X
- 实现 B: 适用于场景 Y

---

## 边界清晰度评估

### Checklist

- [ ] 控制面不依赖执行面的细节实现（只依赖契约/接口）
- [ ] 执行面可以异构与替换（不同环境/供应商/实现并存）
- [ ] 状态只在控制面持久化，执行面是无状态或可重建的
- [ ] 控制面和数据面可以独立扩缩容
- [ ] 网络分区时，数据面可以继续工作（优雅降级）

### 违反分离的代码

| 位置 | 问题 | 影响 | 改进建议 |
|:-----|:-----|:-----|:---------|
| `file:line` | 控制面直接调用环境特定 API | 难以移植 | 抽象为接口 |

---

## 通信模式

### 控制面 → 数据面

| 模式 | 描述 | 适用场景 |
|:-----|:-----|:---------|
| Push | 控制面主动下发配置/指令 | 配置变更 |
| Pull | 数据面主动拉取 | 大规模场景 |
| Watch | 数据面监听变化 | 实时性要求高 |

### 数据面 → 控制面

| 模式 | 描述 | 适用场景 |
|:-----|:-----|:---------|
| Report | 数据面上报状态/指标 | 状态同步 |
| Event | 数据面发送事件 | 异常通知 |

---

## 故障隔离

| 故障场景 | 控制面影响 | 数据面影响 | 恢复策略 |
|:---------|:-----------|:-----------|:---------|
| 控制面不可用 | 无法变更 | 继续按最后配置运行 | ... |
| 单个数据面故障 | 检测并重调度 | 仅影响该节点 | ... |
| 网络分区 | 部分节点不可达 | 继续本地运行 | ... |

---

## 参考案例

| 系统 | 控制面 | 数据面 |
|:-----|:-------|:-------|
| Kubernetes | API Server + etcd + Controllers | kubelet + CRI/CNI/CSI |
| Envoy/Istio | Pilot (xDS) | Envoy Sidecar |
| Kafka | Controller + ZK/KRaft | Broker |
