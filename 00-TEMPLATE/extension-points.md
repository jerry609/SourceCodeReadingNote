# 扩展点设计 (Extension Points)

> 把变化安置在"插件边缘"，把稳定留在"内核中心"。
> 演进不是让核心长大，而是让生态在边缘繁荣。

## 设计原则

1. **识别变化**: 哪些东西变化快？（运行时、网络、存储、云厂商、策略）
2. **封装变化**: 把它们做成可插拔的扩展点
3. **保护核心**: 核心只保留少数通用抽象，不为每个特殊需求长出特例

---

## 架构图

```
                    ┌─────────────────────────────────────┐
                    │            Core (稳定)              │
                    │  ┌─────────────────────────────────┐│
                    │  │       通用抽象 & 接口            ││
                    │  │    (变化慢，向后兼容)            ││
                    │  └─────────────────────────────────┘│
                    └─────────────────────────────────────┘
                                     │
         ┌───────────────────────────┼───────────────────────────┐
         ▼                           ▼                           ▼
┌─────────────────┐       ┌─────────────────┐       ┌─────────────────┐
│  Extension A    │       │  Extension B    │       │  Extension C    │
│  (变化快)       │       │  (变化快)       │       │  (变化快)       │
│  ┌───────────┐  │       │  ┌───────────┐  │       │  ┌───────────┐  │
│  │ Plugin 1  │  │       │  │ Plugin 1  │  │       │  │ Plugin 1  │  │
│  │ Plugin 2  │  │       │  │ Plugin 2  │  │       │  │ Plugin 2  │  │
│  │ Plugin 3  │  │       │  │ Plugin 3  │  │       │  │ Plugin 3  │  │
│  └───────────┘  │       └───────────┘  │  │       │  └───────────┘  │
└─────────────────┘       └─────────────────┘       └─────────────────┘
```

---

## 扩展点清单

| 扩展点 | 类型 | 变化频率 | 隔离机制 | 版本化 | 源码位置 |
|:-------|:-----|:---------|:---------|:-------|:---------|
| ... | Plugin/Webhook/Interface | 高/中/低 | 超时/配额/沙箱 | Yes/No | `path/to/` |

---

## Extension Point 1: [扩展点名称]

### 设计意图

*为什么这里需要可扩展？解决什么问题？*

### 扩展类型

- [ ] **接口扩展**: 实现预定义接口
- [ ] **插件扩展**: 动态加载插件
- [ ] **Webhook 扩展**: HTTP 回调
- [ ] **配置扩展**: 通过配置切换行为
- [ ] **外部控制器**: 独立进程监听事件

### 接口定义

```go
// 扩展点接口
type ExtensionInterface interface {
    Name() string
    // 核心方法
    Execute(ctx context.Context, input *Input) (*Output, error)
}
```

### 注册机制

```go
// 如何注册扩展？
func RegisterExtension(name string, factory ExtensionFactory) {
    // ...
}
```

### 调用时机

*在什么阶段/条件下调用这个扩展点？*

```
请求流程: Step1 → Step2 → [Extension Point] → Step3
```

### 隔离与配额

| 隔离机制 | 配置 | 目的 |
|:---------|:-----|:-----|
| 超时 | 30s | 防止阻塞 |
| 配额 | 100 QPS | 防止过载 |
| 熔断 | 5 次失败 | 快速失败 |
| 沙箱 | 进程隔离 | 故障隔离 |

### 版本策略

*扩展接口如何演进？*

| 版本 | 状态 | 变更 |
|:-----|:-----|:-----|
| v1 | Stable | - |
| v2 | Beta | 新增字段 X |

### 现有实现

| 实现 | 用途 | 维护者 |
|:-----|:-----|:-------|
| Impl-A | 场景 X | Team A |
| Impl-B | 场景 Y | Community |

---

## Extension Point 2: [扩展点名称]

...

---

## 扩展点治理

### 生命周期

```
提议 → 评审 → Alpha → Beta → Stable → Deprecated → Removed
         │                                    │
         └────────── 最少 N 个版本 ────────────┘
```

### 兼容性规则

- [ ] 新增扩展点：向后兼容
- [ ] 修改扩展接口：版本化，保持旧版本可用
- [ ] 移除扩展点：提前 N 个版本标记 Deprecated

### 文档要求

每个扩展点必须有：
- [ ] 接口文档
- [ ] 示例实现
- [ ] 测试用例
- [ ] 性能基准

---

## 反模式警示

| 反模式 | 描述 | 风险 |
|:-------|:-----|:-----|
| 扩展点无约束 | 插件可以阻塞关键路径 | 核心稳定性被绑架 |
| 接口过于宽泛 | 暴露过多内部细节 | 难以演进 |
| 无版本管理 | 随意修改接口 | 破坏现有插件 |
| 过度扩展 | 所有地方都可扩展 | 复杂度爆炸 |

---

## 评估矩阵

| 扩展点 | 使用频率 | 实现数量 | 稳定性 | 文档完善度 |
|:-------|:---------|:---------|:-------|:-----------|
| ... | 高/中/低 | N | Stable/Beta | 完善/待改进 |
