# Chapter 12: The Future of Data Systems

> 数据系统的未来 - 整合与展望

## 核心概念

### 12.1 数据集成

```
             ┌─→ 搜索索引
             │
数据库 ─CDC─→├─→ 缓存
             │
             └─→ 数据仓库
```

**挑战**: 保持多个系统同步

### 12.2 Lambda 架构 vs Kappa 架构

| 架构 | 批处理层 | 流处理层 | 复杂度 |
|:-----|:---------|:---------|:-------|
| Lambda | 全量重算 | 增量更新 | 两套代码 |
| Kappa | 无 | 统一流处理 | 单套代码 |

## 解耦与组合

### 派生数据 vs 原始数据

```
原始数据 (System of Record): 权威数据源
派生数据 (Derived Data): 可重新计算
```

### 数据流拓扑

```
写入 → 日志 → 变换 1 → 变换 2 → 物化视图
              ↓          ↓
           派生视图 1  派生视图 2
```

### 单体 vs 解耦

| 方式 | 特点 |
|:-----|:-----|
| 单体数据库 | 一切内置，简单 |
| 解耦组件 | 灵活组合，复杂 |

## 正确性保证

### 端到端原则

```
应用层 → 传输层 → 存储层

真正的保证应该在端到端实现
中间层的保证可能不够
```

### 幂等性

```
操作可以安全重试
request_id 去重
```

### Exactly-once 的实现

1. **分布式事务**: 2PC, Saga
2. **幂等 + 重试**: 客户端去重
3. **事件溯源**: 从事件重建状态

## 约束执行

### 唯一性约束

```
传统: 数据库强制
流式:
  - 按 key 分区，单分区内保证
  - 或使用分布式事务
```

### 一致性约束

```
账户余额 >= 0

流式处理如何保证？
- 单分区内串行处理
- 或异步检查 + 补偿
```

## 数据伦理

### 隐私问题

- 数据收集的边界
- 用户知情同意
- 数据删除权 (GDPR)

### 预测性分析的风险

- 算法偏见
- 自我实现的预言
- 反馈循环

## 要点总结

1. 数据集成是现代系统的核心挑战
2. 派生数据可以通过事件日志重建
3. 端到端的正确性比组件级保证更重要
4. 数据系统设计需要考虑伦理问题

## 思考题

- [ ] 如何设计可演化的数据系统？
- [ ] 何时使用单体数据库，何时解耦？
- [ ] 如何在分布式系统中保证约束？

## 源码关联

| 概念 | 相关项目 | 实现 |
|:-----|:---------|:-----|
| 派生数据 | JuiceFS | 缓存 = 派生自对象存储 |
| 幂等操作 | JuiceFS | Slice ID 唯一性 |
| 数据删除 | JuiceFS | `juicefs gc` 垃圾回收 |
