# Chapter 6: Partitioning

> 分区 - 数据分片策略

## 核心概念

### 6.1 分区的目的

- **可扩展性**: 单机存不下，分散到多台机器
- **并行处理**: 查询可以在多个分区并行执行

### 6.2 分区与复制

```
分区 (Partitioning): 数据分散存储
复制 (Replication): 数据冗余备份

通常同时使用: 每个分区有多个副本
```

## 分区策略

### 1. 按 Key Range 分区

```
分区 A: a-f
分区 B: g-m
分区 C: n-z
```

**优点**: 支持范围查询
**缺点**: 可能热点不均 (如按时间戳分区)

### 2. 按 Hash 分区

```
partition = hash(key) % N
```

**优点**: 负载均匀
**缺点**: 不支持范围查询

### 3. 混合策略

```
(user_id, timestamp)
↓
先按 user_id Hash → 分区
再按 timestamp 排序 → 分区内范围查询
```

## 热点问题

### 问题场景

- 明星发推文 → 单个 key 大量写入
- 热门商品 → 单个 key 大量读取

### 解决方案

| 策略 | 实现 |
|:-----|:-----|
| Key 加盐 | `key_01`, `key_02`, ..., `key_99` |
| 应用层路由 | 热点 key 特殊处理 |
| 缓存 | 热点数据缓存在前端 |

## 二级索引分区

### 1. 本地索引 (Document-Partitioned)

```
每个分区维护自己的索引
查询需要扫描所有分区 (Scatter/Gather)
```

**优点**: 写入只涉及单个分区
**缺点**: 读取需要查询所有分区

### 2. 全局索引 (Term-Partitioned)

```
索引也按 term 分区
color:red → 分区 A
color:blue → 分区 B
```

**优点**: 读取只查询相关分区
**缺点**: 写入可能涉及多个分区

## 再平衡 (Rebalancing)

### 触发条件

- 负载增加，需要更多节点
- 节点故障，需要重新分配
- 数据倾斜，需要调整

### 策略对比

| 策略 | 说明 | 问题 |
|:-----|:-----|:-----|
| hash % N | 最简单 | 节点变化时几乎所有数据迁移 |
| 固定分区数 | 分区数 >> 节点数 | 需要预估分区数 |
| 动态分区 | 分区大小触发分裂/合并 | 初始只有一个分区 |
| 按节点分区 | 每个节点固定分区数 | Cassandra 使用 |

### 一致性哈希 (Consistent Hashing)

```
       0
      /|\
     / | \
  节点A 节点B 节点C
    \  |  /
     \ | /
      \|/
       0
```

**特点**: 节点变化时只迁移 1/N 数据

## 请求路由

### 三种方式

| 方式 | 说明 | 示例 |
|:-----|:-----|:-----|
| 客户端感知 | 客户端知道分区分布 | Cassandra |
| 路由层 | 专门的路由服务 | ZooKeeper + Proxy |
| 任意节点 | 节点间转发 | Gossip 协议 |

### 元数据存储

- **ZooKeeper**: HBase, Kafka, SolrCloud
- **etcd**: Kubernetes
- **Gossip**: Cassandra, Riak

## 要点总结

1. Hash 分区均匀但不支持范围查询
2. 二级索引有本地和全局两种策略
3. 再平衡要最小化数据迁移
4. 请求路由需要元数据协调

## 思考题

- [ ] 什么时候用 Key Range 分区？什么时候用 Hash 分区？
- [ ] 如何处理分区热点？
- [ ] 一致性哈希解决了什么问题？

## 源码关联

| 概念 | 相关项目 | 实现 |
|:-----|:---------|:-----|
| Chunk 分片 | JuiceFS | 64MB Chunk + 4MB Block |
| Hash 分布 | JuiceFS | HashPrefix 对象 Key |
| 元数据路由 | TiKV | PD (Placement Driver) |
