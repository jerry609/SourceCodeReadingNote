# Chapter 9: Consistency and Consensus

> 一致性与共识 - 分布式协调的核心

## 核心概念

### 9.1 一致性模型

| 模型 | 强度 | 说明 |
|:-----|:-----|:-----|
| 线性一致性 | 最强 | 表现得像只有一个副本 |
| 顺序一致性 | 较强 | 所有操作有全局顺序 |
| 因果一致性 | 中等 | 因果相关的操作有序 |
| 最终一致性 | 最弱 | 最终收敛到相同状态 |

### 9.2 共识问题

让所有节点对某个值达成一致

**应用场景**:
- Leader 选举
- 原子提交
- 分布式锁

## 线性一致性 (Linearizability)

### 定义

```
所有操作表现得像在单个时间点原子执行
操作顺序与实际墙上时间一致
```

### 示例

```
Client A: write(x, 1)           |--------|
Client B: read(x) → ?     |------|
                          t1    t2      t3

如果 B 的读取在 A 写入期间，可能返回 0 或 1
但一旦任何客户端读到 1，后续所有读取必须返回 1
```

### 实现方式

- 单主复制 (同步)
- 共识算法 (Raft, Paxos)
- 单节点 (无复制)

### 代价

- 网络延迟增加
- 网络分区时不可用 (CAP 定理)

## CAP 定理

```
C - Consistency (一致性, 线性一致性)
A - Availability (可用性)
P - Partition Tolerance (分区容错)

三者只能选两个: CP 或 AP
```

**更准确的表述**: 网络分区时，必须在一致性和可用性间选择

## 因果一致性

### 定义

```
因果相关的操作保持顺序
并发的操作可以任意顺序
```

### 实现

- 向量时钟 (Vector Clock)
- Lamport 时间戳

### 优势

- 不需要线性一致性的协调开销
- 比线性一致性更好的可用性

## 全序广播 (Total Order Broadcast)

### 定义

```
1. 可靠传递: 消息送达所有节点
2. 全序: 所有节点以相同顺序接收消息
```

### 与共识的等价性

- 全序广播 ⟺ 共识
- 可以互相实现

## 共识算法

### Paxos

**角色**:
- Proposer: 提出值
- Acceptor: 接受/拒绝
- Learner: 学习已决定的值

**阶段**:
1. Prepare (承诺不接受更低编号的提案)
2. Accept (接受值)

### Raft

**角色**:
- Leader: 处理所有请求
- Follower: 被动复制
- Candidate: 参与选举

**机制**:
- Term (任期号)
- 日志复制
- Leader 选举

### ZAB (Zookeeper Atomic Broadcast)

类似 Raft，ZooKeeper 使用

## 共识的限制

| 限制 | 说明 |
|:-----|:-----|
| 同步假设 | 需要故障检测器 |
| 活性与安全性 | 可能永不结束 (FLP 不可能) |
| 节点数量 | 奇数节点 (2f+1 容忍 f 故障) |
| 性能开销 | 多轮消息往返 |

## 成员与协调服务

### ZooKeeper/etcd 提供的功能

| 功能 | 说明 |
|:-----|:-----|
| 线性一致性读写 | 强一致性 KV |
| 全序操作 | Zxid / Revision |
| 故障检测 | Session 心跳 |
| 变更通知 | Watch 机制 |

### 典型用途

- 分布式锁
- Leader 选举
- 服务发现
- 配置管理

## 要点总结

1. 线性一致性是最强的一致性模型
2. CAP 定理限制了分布式系统的能力
3. 共识算法 (Raft/Paxos) 解决分布式协调
4. ZooKeeper/etcd 封装了共识的复杂性

## 思考题

- [ ] 线性一致性和可序列化的区别是什么？
- [ ] 为什么共识算法需要奇数节点？
- [ ] Raft 如何保证 Leader 唯一性？

## 源码关联

| 概念 | 相关项目 | 实现 |
|:-----|:---------|:-----|
| Raft | TiKV | 多数派复制 |
| Leader 选举 | Redis Sentinel | 哨兵选举 |
| 分布式锁 | etcd | 租约 + 比较并交换 |
| 线性一致性读 | TiKV | Raft Read Index |
