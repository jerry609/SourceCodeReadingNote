# Chapter 5: Replication

> 复制 - 多节点数据一致性

## 核心概念

### 5.1 复制的目的

| 目的 | 说明 |
|:-----|:-----|
| 高可用 | 单点故障时仍可服务 |
| 低延迟 | 就近读取数据 |
| 扩展读取 | 分担读负载 |

### 5.2 三种复制模式

| 模式 | 写入节点 | 复杂度 |
|:-----|:---------|:-------|
| 单主复制 | 1 个 | 低 |
| 多主复制 | 多个 | 高 |
| 无主复制 | 任意节点 | 中 |

## 单主复制 (Leader-Based)

### 同步 vs 异步复制

```
Client → Leader → Follower 1 (同步)
              ↘ Follower 2 (异步)
```

| 类型 | 优点 | 缺点 |
|:-----|:-----|:-----|
| 同步 | 数据一致 | 延迟高，可用性低 |
| 异步 | 低延迟 | 可能丢失数据 |
| 半同步 | 折中 | 至少一个同步副本 |

### 故障恢复

- **Follower 故障**: 追赶复制日志
- **Leader 故障**: Failover (选举新 Leader)

### Failover 的挑战

- 脑裂 (Split Brain)
- 数据丢失 (异步复制)
- 确定 Leader 是否真的故障

## 复制日志实现

| 方式 | 说明 | 示例 |
|:-----|:-----|:-----|
| 语句复制 | 复制 SQL 语句 | MySQL (旧版) |
| WAL 传输 | 复制存储引擎日志 | PostgreSQL |
| 逻辑日志 | 行级变更记录 | MySQL binlog |
| 触发器 | 应用层复制 | Oracle GoldenGate |

## 复制延迟问题

### 读己之写 (Read Your Writes)

```
User → Write to Leader → (延迟) → Read from Follower
                                    ↓
                              看不到刚写入的数据!
```

**解决方案**:
- 读自己修改的数据时走 Leader
- 记录最后写入时间戳

### 单调读 (Monotonic Reads)

```
Read 1 (Follower A) → 看到新数据
Read 2 (Follower B) → 看到旧数据 (时光倒流!)
```

**解决方案**: 同一用户总是读同一副本

### 一致前缀读 (Consistent Prefix Reads)

```
A: "你好吗?" (t=1)
B: "我很好" (t=2)

观察者可能先看到回答再看到问题!
```

**解决方案**: 因果相关的写入发送到同一分区

## 多主复制

### 适用场景

- 多数据中心部署
- 离线客户端 (如手机 App)
- 协作编辑 (如 Google Docs)

### 写冲突处理

| 策略 | 说明 |
|:-----|:-----|
| 冲突避免 | 同一记录只在一个数据中心写 |
| 最后写入胜出 (LWW) | 按时间戳选择 |
| 合并值 | 保留所有版本让用户决定 |
| CRDT | 自动合并的数据结构 |

## 无主复制 (Leaderless)

### Quorum 机制

```
N = 副本总数
W = 写入成功的最小副本数
R = 读取的最小副本数

一致性要求: W + R > N
```

### 常见配置

| N | W | R | 特点 |
|:--|:--|:--|:-----|
| 3 | 2 | 2 | 平衡读写 |
| 3 | 3 | 1 | 写慢读快 |
| 3 | 1 | 3 | 写快读慢 |

### 读修复与反熵

- **读修复**: 读取时发现过时副本，写回最新值
- **反熵**: 后台进程扫描并修复不一致

## 要点总结

1. 单主复制简单但 Leader 是瓶颈
2. 复制延迟导致各种一致性问题
3. 多主复制需要处理写冲突
4. Quorum 可以在一致性和可用性间权衡

## 思考题

- [ ] 什么场景适合同步复制？异步复制？
- [ ] 如何实现 Read Your Writes？
- [ ] W + R > N 为什么能保证一致性？

## 源码关联

| 概念 | 相关项目 | 实现 |
|:-----|:---------|:-----|
| 主从复制 | Redis | 哨兵模式 |
| 多副本 | JuiceFS | 对象存储内置多副本 |
| Quorum | TiKV | Raft 多数派写入 |
